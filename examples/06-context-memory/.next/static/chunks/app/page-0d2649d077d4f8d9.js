(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{1113:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>i});var a=s(5155),r=s(2115),c=s(3490);function n(e){let{executeInstruction:t}=e,[s,n]=(0,r.useState)(!1),[l,d]=(0,r.useState)([]),o=(0,r.useRef)(null),{parseAndExecuteMessage:i}=function(e){let{executeInstruction:t}=e;return{parseAndExecuteMessage:(0,r.useCallback)(e=>{if(!(/```json[\s\S]*?```/.test(e)||/\{[\s\S]*?"action"[\s\S]*?\}/.test(e)))return null;let s=function(e){try{let s=e.match(/```json\s*\n([\s\S]*?)\n```/),a="";if(s)a=s[1].trim();else{let t=e.match(/\{[\s\S]*?\}/);if(!t)return null;a=t[0]}console.log("提取的JSON字符串:",a);let r=JSON.parse(a);if("object"==typeof r&&null!==r&&"action"in r&&["add","complete","delete","list","clear_completed","clear_all"].includes(r.action)){var t;if(("add"===r.action||"complete"===r.action||"delete"===r.action)&&(!r.task||"string"!=typeof r.task||""===r.task.trim()))return console.warn("操作需要task字段但未提供或为空"),null;return{action:r.action,task:null==(t=r.task)?void 0:t.trim(),response:r.response}}return console.warn("JSON结构验证失败:",r),null}catch(e){return console.warn("JSON解析失败:",e),null}}(e);if(!s)return console.warn("无法解析AI返回的指令"),{success:!1,message:"指令格式错误，无法解析"};let a={action:s.action,task:s.task};return console.log("执行AI指令:",a),t(a)},[t]),processAIResponse:(0,r.useCallback)(e=>{let s=[],a=e.match(/\{[^}]*"action"[^}]*\}/g);return a&&a.forEach((e,a)=>{try{let r=JSON.parse(e);if(r.action&&["add","complete","delete","list","clear_completed","clear_all"].includes(r.action)){let e={action:r.action,task:r.task},c=t(e);s.push(c),console.log("执行第".concat(a+1,"个指令:"),e,"结果:",c)}}catch(t){console.warn("解析指令失败:",e,t),s.push({success:!1,message:"指令".concat(a+1,"解析失败")})}}),s},[t])}}({executeInstruction:t}),{messages:u,input:g,handleInputChange:x,handleSubmit:m,isLoading:h}=(0,c.Y_)({api:"/api/chat",onFinish:e=>{let t=i(e.content);t&&d(e=>[...e.slice(-9),{id:"result_".concat(Date.now()),message:t.message||"执行完成",success:t.success,timestamp:Date.now()}])}}),p=()=>{var e;null==(e=o.current)||e.scrollIntoView({behavior:"smooth"})};(0,r.useEffect)(()=>{p()},[u,l]);let b=()=>{for(let e=u.length-1;e>=0;e--){let t=u[e];if("assistant"===t.role&&t.content.includes('"action": "add"')){let e=t.content.match(/"task":\s*"([^"]+)"/);if(e)return e[1]}}return null},f=e=>{let t=b(),s=e;return(e.includes("刚才")||e.includes("最后")||e.includes("上个"))&&t&&(s+='\n(注：最近添加的任务是"'.concat(t,'")')),(e.includes("再加")||e.includes("再添加"))&&t&&(s+='\n(注：上次添加的是"'.concat(t,'"，请添加类似的任务)')),s},k=b(),y=(()=>{let e=[];for(let t=u.length-1;t>=0&&e.length<5;t--){let s=u[t];if("assistant"===s.role){let a=s.content.match(/"action":\s*"([^"]+)"/),r=s.content.match(/"task":\s*"([^"]+)"/);a&&e.unshift({action:a[1],task:r?r[1]:"",timestamp:Date.now()-(u.length-1-t)*6e4})}}return e})();return(0,a.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg h-full flex flex-col",children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-800 dark:text-white",children:"\uD83E\uDD16 AI 助手"}),(0,a.jsx)("button",{onClick:()=>n(!s),className:"px-3 py-1 text-xs rounded-full transition-colors ".concat(s?"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400"),title:"切换上下文视图",children:s?"\uD83D\uDCAC 对话":"\uD83D\uDCCB 上下文"})]}),(0,a.jsxs)("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:["支持上下文对话 | 消息: ",u.length]}),k&&(0,a.jsx)("div",{className:"mt-2 p-2 bg-blue-50 dark:bg-blue-900/20 rounded text-xs",children:(0,a.jsxs)("span",{className:"text-blue-600 dark:text-blue-400",children:["\uD83D\uDCA1 最后添加: “",k,"”"]})})]}),(0,a.jsx)("div",{className:"flex-1 p-4 overflow-y-auto",children:s?(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-3",children:"\uD83D\uDCCB 对话上下文"}),k&&(0,a.jsxs)("div",{className:"p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-sm",children:[(0,a.jsx)("strong",{children:"最后添加的任务:"})," ",k]}),y.length>0&&(0,a.jsxs)("div",{className:"p-2 bg-green-50 dark:bg-green-900/20 rounded-lg text-sm",children:[(0,a.jsx)("strong",{children:"最近操作:"}),(0,a.jsx)("ul",{className:"mt-1 space-y-1",children:y.map((e,t)=>(0,a.jsxs)("li",{className:"text-xs",children:["• ",e.action,": ",e.task]},t))})]}),(0,a.jsxs)("div",{className:"p-2 bg-gray-50 dark:bg-gray-900/20 rounded-lg text-sm",children:[(0,a.jsx)("strong",{children:"对话历史:"})," ",u.length," 条消息"]})]}):(0,a.jsxs)("div",{className:"space-y-4",children:[0===u.length&&(0,a.jsxs)("div",{className:"text-center text-gray-500 dark:text-gray-400 mt-8",children:[(0,a.jsx)("p",{className:"text-2xl mb-2",children:"\uD83D\uDC4B"}),(0,a.jsx)("p",{children:"你好！我是你的 AI 助手"}),(0,a.jsx)("p",{className:"text-sm mt-1",children:"支持上下文对话，试试说“再加一个任务”"})]}),u.map(e=>(0,a.jsx)("div",{className:"flex ".concat("user"===e.role?"justify-end":"justify-start"),children:(0,a.jsx)("div",{className:"max-w-[85%] px-3 py-2 rounded-lg text-sm ".concat("user"===e.role?"bg-blue-500 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white"),children:(0,a.jsx)("div",{className:"whitespace-pre-wrap",children:e.content})})},e.id)),l.map(e=>(0,a.jsx)("div",{className:"flex justify-center",children:(0,a.jsx)("div",{className:"bg-green-100 dark:bg-green-900/30 border border-green-300 dark:border-green-700 text-green-800 dark:text-green-300 px-3 py-2 rounded-lg text-sm max-w-[90%]",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-green-600",children:"⚡"}),(0,a.jsxs)("span",{children:["指令执行结果：",e.success?"✅":"❌"," ",e.message]})]})})},e.id)),h&&(0,a.jsx)("div",{className:"flex justify-start",children:(0,a.jsx)("div",{className:"bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white px-3 py-2 rounded-lg text-sm",children:(0,a.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-3 w-3 border-b-2 border-blue-500"}),(0,a.jsx)("span",{children:"正在思考中..."})]})})}),(0,a.jsx)("div",{ref:o})]})}),(0,a.jsx)("div",{className:"border-t border-gray-200 dark:border-gray-700 p-3",children:(0,a.jsxs)("form",{onSubmit:e=>{if(e.preventDefault(),!g.trim()||h)return;let t=f(g.trim());t!==g.trim()?(x({target:{value:t}}),setTimeout(()=>{m(e),x({target:{value:""}})},0)):m(e)},className:"flex gap-2",children:[(0,a.jsx)("input",{value:g,onChange:x,placeholder:"输入消息，支持'再加一个'、'完成刚才的'等上下文指令...",disabled:h,className:"flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white disabled:opacity-50"}),(0,a.jsx)("button",{type:"submit",disabled:h||!g.trim(),className:"px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed text-sm",children:"发送"})]})})]})}class l{registerFunction(e,t){this.functionMap.set(e,t)}executeInstruction(e){let t=this.functionMap.get(e.action);if(!t)return console.warn('未找到操作 "'.concat(e.action,'" 对应的函数')),{success:!1,message:"不支持的操作: ".concat(e.action)};try{let s;switch(e.action){case"add":s=t(e.task);break;case"complete":case"delete":s=t(e.id||e.task);break;default:s=t()}if("object"==typeof s&&null!==s&&"success"in s)return s;return{success:!0,message:'操作 "'.concat(e.action,'" 执行成功'),data:s}}catch(t){return console.error("执行指令时发生错误:",t),{success:!1,message:'执行操作 "'.concat(e.action,'" 时发生错误')}}}getRegisteredActions(){return Array.from(this.functionMap.keys())}supportsAction(e){return this.functionMap.has(e)}constructor(){this.functionMap=new Map}}let d=new l;function o(e,t){return e.find(e=>e.text.toLowerCase().includes(t.toLowerCase())||t.toLowerCase().includes(e.text.toLowerCase()))}function i(){let[e,t]=(0,r.useState)([]),[s,c]=(0,r.useState)(""),{recordAction:l}=function(){let[e,t]=(0,r.useState)([]),[s,a]=(0,r.useState)({recentActions:[],recentMessages:[]}),c=(0,r.useCallback)(e=>{let s={...e,id:"mem_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),timestamp:Date.now()};return t(e=>[...e.slice(-49),s]),s},[]),n=(0,r.useCallback)(e=>{c({type:"user_message",content:e}),a(t=>({...t,recentMessages:[...t.recentMessages.slice(-9),{content:e,timestamp:Date.now(),type:"user"}]}))},[c]),l=(0,r.useCallback)(e=>{c({type:"ai_response",content:e}),a(t=>({...t,recentMessages:[...t.recentMessages.slice(-9),{content:e,timestamp:Date.now(),type:"ai"}]}))},[c]),d=(0,r.useCallback)((e,t,s)=>{c({type:"action_executed",content:"执行动作: ".concat(e).concat(s?" - ".concat(s):""),metadata:{action:e,taskId:t,taskText:s}}),a(a=>({...a,recentActions:[...a.recentActions.slice(-9),{action:e,taskId:t,taskText:s,timestamp:Date.now()}],..."add"===e&&t&&s?{lastAddedTask:{id:t,text:s,timestamp:Date.now()}}:{}}))},[c]),o=(0,r.useCallback)((e,t)=>{c({type:"context_reference",content:t,metadata:{reference:e}})},[c]),i=(0,r.useCallback)(e=>{let t=e.toLowerCase(),a="";if(t.includes("刚才")||t.includes("最后")||t.includes("上一个")||t.includes("上个"))if(t.includes("添加")||t.includes("任务")){if(s.lastAddedTask)return o("last_added_task",a='引用最后添加的任务: "'.concat(s.lastAddedTask.text,'" (ID: ').concat(s.lastAddedTask.id,")")),{type:"task_reference",taskId:s.lastAddedTask.id,taskText:s.lastAddedTask.text,resolvedText:a}}else{let e=s.recentActions[s.recentActions.length-1];if(e)return o("last_action",a="引用最后的动作: ".concat(e.action).concat(e.taskText?" - ".concat(e.taskText):"")),{type:"action_reference",action:e.action,taskId:e.taskId,taskText:e.taskText,resolvedText:a}}if(t.includes("再加")||t.includes("再添加")){let e=s.recentActions.slice().reverse().find(e=>"add"===e.action);if(e)return o("repeat_add_pattern",a='基于上次添加的任务模式: "'.concat(e.taskText,'"')),{type:"repeat_pattern",action:"add",referenceTask:e.taskText,resolvedText:a}}return null},[s,o]),u=(0,r.useCallback)(()=>{let e=s.recentMessages.slice(-6),t=s.recentActions.slice(-5),a="";return e.length>0&&(a+="最近的对话:\n",e.forEach(e=>{a+="".concat("user"===e.type?"用户":"AI",": ").concat(e.content,"\n")}),a+="\n"),t.length>0&&(a+="最近的操作:\n",t.forEach(e=>{a+="".concat(e.action,": ").concat(e.taskText||"无具体任务","\n")}),a+="\n"),s.lastAddedTask&&(a+='最后添加的任务: "'.concat(s.lastAddedTask.text,'" (ID: ').concat(s.lastAddedTask.id,")\n")),a},[s]);return{memory:e,context:s,addMemoryEntry:c,recordUserMessage:n,recordAIResponse:l,recordAction:d,recordContextReference:o,resolveContextReference:i,getContextSummary:u,clearMemory:(0,r.useCallback)(()=>{t([]),a({recentActions:[],recentMessages:[]})},[])}}(),{executeInstruction:i,getSupportedActions:u,addTodo:g,clearCompleted:x,clearAll:m}=function(e){let{todos:t,setTodos:s,onActionExecuted:a}=e,c=(0,r.useCallback)(e=>{let r="string"==typeof e?e:String(e||"");if(!r||""===r.trim())return{success:!1,message:"任务内容不能为空"};let c={id:Date.now(),text:r.trim(),completed:!1};return s([...t,c]),null==a||a("add",c.id,c.text),{success:!0,message:"已添加任务: ".concat(r),data:c}},[t,s,a]),n=(0,r.useCallback)(e=>{let r;return e?(r="number"==typeof e?t.find(t=>t.id===e):o(t,e))?r.completed?{success:!1,message:'任务 "'.concat(r.text,'" 已经完成了')}:(s(t.map(e=>e.id===r.id?{...e,completed:!0}:e)),null==a||a("complete",r.id,r.text),{success:!0,message:"已完成任务: ".concat(r.text),data:{...r,completed:!0}}):{success:!1,message:"未找到任务: ".concat(e)}:{success:!1,message:"请指定要完成的任务"}},[t,s,a]),l=(0,r.useCallback)(e=>{let r;return e?(r="number"==typeof e?t.find(t=>t.id===e):o(t,e))?(s(t.filter(e=>e.id!==r.id)),null==a||a("delete",r.id,r.text),{success:!0,message:"已删除任务: ".concat(r.text),data:r}):{success:!1,message:"未找到任务: ".concat(e)}:{success:!1,message:"请指定要删除的任务"}},[t,s,a]),i=(0,r.useCallback)(()=>{let e=t.filter(e=>e.completed).length,s=t.length-e;return null==a||a("list"),{success:!0,message:"共有 ".concat(t.length," 个任务，其中 ").concat(e," 个已完成，").concat(s," 个待完成"),data:t}},[t,a]),u=(0,r.useCallback)(()=>{let e=t.filter(e=>e.completed);return 0===e.length?{success:!1,message:"没有已完成的任务需要清除"}:(s(t.filter(e=>!e.completed)),null==a||a("clear_completed"),{success:!0,message:"已清除 ".concat(e.length," 个已完成的任务"),data:e})},[t,s,a]),g=(0,r.useCallback)(()=>{if(0===t.length)return{success:!1,message:"没有任务需要清除"};let e=t.length;return s([]),null==a||a("clear_all"),{success:!0,message:"已清除所有 ".concat(e," 个任务"),data:t}},[t,s,a]);return(0,r.useEffect)(()=>{d.registerFunction("add",c),d.registerFunction("complete",n),d.registerFunction("delete",l),d.registerFunction("list",i),d.registerFunction("clear_completed",u),d.registerFunction("clear_all",g)},[c,n,l,i,u,g]),{executeInstruction:(0,r.useCallback)(e=>{console.log("执行指令:",e);let t=d.executeInstruction(e);return console.log("执行结果:",t),t},[]),getSupportedActions:(0,r.useCallback)(()=>d.getRegisteredActions(),[]),addTodo:c,completeTodo:n,deleteTodo:l,listTodos:i,clearCompleted:u,clearAll:g}}({todos:e,setTodos:t,onActionExecuted:l}),h=()=>{if(""!==s.trim()){let e=g(s.trim());e.success?c(""):console.error("添加任务失败:",e.message)}},p=e=>{let t=i({action:"delete",id:e});t.success||console.error("删除任务失败:",t.message)},b=s=>{let a=e.find(e=>e.id===s);if(a&&!a.completed){let e=i({action:"complete",id:s});e.success||console.error("完成任务失败:",e.message)}else a&&a.completed&&t(e.map(e=>e.id===s?{...e,completed:!1}:e))},f=e.filter(e=>e.completed).length,k=e.length;return(0,a.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 p-4",children:(0,a.jsxs)("div",{className:"max-w-6xl mx-auto h-[calc(100vh-2rem)] flex flex-col lg:flex-row gap-6",children:[(0,a.jsxs)("div",{className:"flex-1 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 overflow-y-auto",children:[(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-center text-gray-800 dark:text-white mb-2",children:"\uD83D\uDCDD 智能上下文记忆待办事项"}),(0,a.jsxs)("p",{className:"text-center text-sm text-gray-600 dark:text-gray-400",children:["AI 指令映射 + 上下文记忆 | 支持操作: ",u().join(", ")]}),(0,a.jsx)("p",{className:"text-center text-xs text-gray-500 dark:text-gray-500 mt-1",children:"\uD83D\uDCA1 支持上下文引用：“再加一个任务”、“完成刚才那个”、“删除最后添加的”"})]}),(0,a.jsxs)("div",{className:"flex gap-2 mb-6",children:[(0,a.jsx)("input",{type:"text",value:s,onChange:e=>c(e.target.value),onKeyPress:e=>"Enter"===e.key&&h(),placeholder:"添加新任务...",className:"flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"}),(0,a.jsx)("button",{onClick:h,className:"px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors duration-200 font-medium",children:"添加"})]}),k>0&&(0,a.jsx)("div",{className:"mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg",children:(0,a.jsxs)("p",{className:"text-sm text-gray-600 dark:text-gray-300 text-center",children:["总计: ",k," 任务 | 已完成: ",f," 任务 | 剩余: ",k-f," 任务"]})}),(0,a.jsx)("div",{className:"space-y-2",children:0===e.length?(0,a.jsxs)("div",{className:"text-center py-8",children:[(0,a.jsx)("p",{className:"text-gray-500 dark:text-gray-400 text-lg",children:"暂无任务，添加一个新任务开始吧！"}),(0,a.jsxs)("p",{className:"text-sm text-gray-400 dark:text-gray-500 mt-2",children:["\uD83D\uDCA1 你可以直接在此添加，或向",(0,a.jsx)("span",{className:"lg:inline hidden",children:"右侧"}),(0,a.jsx)("span",{className:"lg:hidden inline",children:"下方"}),"的 AI 助手发送指令"]}),(0,a.jsx)("p",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:"例如：“帮我添加一个学习任务” 或 “添加买菜任务”"}),(0,a.jsx)("p",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:"\uD83D\uDD17 支持上下文：“再加一个类似的” 或 “完成刚才那个”"})]}):e.map(e=>(0,a.jsxs)("div",{className:"flex items-center gap-3 p-3 rounded-lg border transition-all duration-200 ".concat(e.completed?"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800":"bg-white dark:bg-gray-700 border-gray-200 dark:border-gray-600 hover:shadow-md"),children:[(0,a.jsx)("input",{type:"checkbox",checked:e.completed,onChange:()=>b(e.id),className:"w-5 h-5 text-blue-600 rounded focus:ring-blue-500 focus:ring-2"}),(0,a.jsx)("span",{className:"flex-1 ".concat(e.completed?"line-through text-gray-500 dark:text-gray-400":"text-gray-800 dark:text-white"),children:e.text}),(0,a.jsxs)("span",{className:"text-xs text-gray-400 dark:text-gray-500",children:["ID: ",e.id]}),(0,a.jsx)("button",{onClick:()=>p(e.id),className:"px-3 py-1 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded transition-colors duration-200",title:"删除任务",children:"\uD83D\uDDD1️"})]},e.id))}),e.length>0&&(0,a.jsxs)("div",{className:"mt-6 flex gap-2 justify-center",children:[(0,a.jsxs)("button",{onClick:()=>{let e=x();e.success||console.error("清除已完成任务失败:",e.message)},className:"px-4 py-2 text-sm bg-red-100 hover:bg-red-200 text-red-700 rounded-lg transition-colors duration-200",disabled:0===f,children:["清除已完成 (",f,")"]}),(0,a.jsx)("button",{onClick:()=>{let e=m();e.success||console.error("清除所有任务失败:",e.message)},className:"px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors duration-200",children:"清除全部"})]})]}),(0,a.jsx)("div",{className:"w-full lg:w-80 h-96 lg:h-full",children:(0,a.jsx)(n,{executeInstruction:i})})]})})}},7257:(e,t,s)=>{Promise.resolve().then(s.bind(s,1113))}},e=>{var t=t=>e(e.s=t);e.O(0,[490,441,684,358],()=>t(7257)),_N_E=e.O()}]);
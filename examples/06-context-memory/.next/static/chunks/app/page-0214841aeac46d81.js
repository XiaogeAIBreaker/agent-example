(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{1113:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>u});var a=s(5155),r=s(2115),c=s(3490);function n(){let[e,t]=(0,r.useState)([]),[s,a]=(0,r.useState)({recentActions:[],recentMessages:[]}),c=(0,r.useCallback)(e=>{let s={...e,id:"mem_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9)),timestamp:Date.now()};return t(e=>[...e.slice(-49),s]),s},[]),n=(0,r.useCallback)(e=>{c({type:"user_message",content:e}),a(t=>({...t,recentMessages:[...t.recentMessages.slice(-9),{content:e,timestamp:Date.now(),type:"user"}]}))},[c]),l=(0,r.useCallback)(e=>{c({type:"ai_response",content:e}),a(t=>({...t,recentMessages:[...t.recentMessages.slice(-9),{content:e,timestamp:Date.now(),type:"ai"}]}))},[c]),d=(0,r.useCallback)((e,t,s)=>{c({type:"action_executed",content:"执行动作: ".concat(e).concat(s?" - ".concat(s):""),metadata:{action:e,taskId:t,taskText:s}}),a(a=>({...a,recentActions:[...a.recentActions.slice(-9),{action:e,taskId:t,taskText:s,timestamp:Date.now()}],..."add"===e&&t&&s?{lastAddedTask:{id:t,text:s,timestamp:Date.now()}}:{}}))},[c]),o=(0,r.useCallback)((e,t)=>{c({type:"context_reference",content:t,metadata:{reference:e}})},[c]),i=(0,r.useCallback)(e=>{let t=e.toLowerCase(),a="";if(t.includes("刚才")||t.includes("最后")||t.includes("上一个")||t.includes("上个"))if(t.includes("添加")||t.includes("任务")){if(s.lastAddedTask)return o("last_added_task",a='引用最后添加的任务: "'.concat(s.lastAddedTask.text,'" (ID: ').concat(s.lastAddedTask.id,")")),{type:"task_reference",taskId:s.lastAddedTask.id,taskText:s.lastAddedTask.text,resolvedText:a}}else{let e=s.recentActions[s.recentActions.length-1];if(e)return o("last_action",a="引用最后的动作: ".concat(e.action).concat(e.taskText?" - ".concat(e.taskText):"")),{type:"action_reference",action:e.action,taskId:e.taskId,taskText:e.taskText,resolvedText:a}}if(t.includes("再加")||t.includes("再添加")){let e=s.recentActions.slice().reverse().find(e=>"add"===e.action);if(e)return o("repeat_add_pattern",a='基于上次添加的任务模式: "'.concat(e.taskText,'"')),{type:"repeat_pattern",action:"add",referenceTask:e.taskText,resolvedText:a}}return null},[s,o]),u=(0,r.useCallback)(()=>{let e=s.recentMessages.slice(-6),t=s.recentActions.slice(-5),a="";return e.length>0&&(a+="最近的对话:\n",e.forEach(e=>{a+="".concat("user"===e.type?"用户":"AI",": ").concat(e.content,"\n")}),a+="\n"),t.length>0&&(a+="最近的操作:\n",t.forEach(e=>{a+="".concat(e.action,": ").concat(e.taskText||"无具体任务","\n")}),a+="\n"),s.lastAddedTask&&(a+='最后添加的任务: "'.concat(s.lastAddedTask.text,'" (ID: ').concat(s.lastAddedTask.id,")\n")),a},[s]);return{memory:e,context:s,addMemoryEntry:c,recordUserMessage:n,recordAIResponse:l,recordAction:d,recordContextReference:o,resolveContextReference:i,getContextSummary:u,clearMemory:(0,r.useCallback)(()=>{t([]),a({recentActions:[],recentMessages:[]})},[])}}function l(e){let{executeInstruction:t}=e,[s,l]=(0,r.useState)(!1),d=(0,r.useRef)(null),{memory:o,context:i,recordUserMessage:u,recordAIResponse:x,resolveContextReference:g,getContextSummary:m,clearMemory:p}=n(),{parseAndExecuteMessage:h}=function(e){let{executeInstruction:t}=e;return{parseAndExecuteMessage:(0,r.useCallback)(e=>{if(!/\{[^}]*"action"[^}]*\}/.test(e))return null;let s=function(e){try{let s=e.match(/\{[^}]*\}/);if(!s)return null;let a=s[0],r=JSON.parse(a);if("object"==typeof r&&null!==r&&"action"in r&&["add","complete","delete","list","clear_completed","clear_all"].includes(r.action)){var t;if(("add"===r.action||"complete"===r.action||"delete"===r.action)&&(!r.task||"string"!=typeof r.task||""===r.task.trim()))return null;return{action:r.action,task:null==(t=r.task)?void 0:t.trim()}}return null}catch(e){return console.warn("JSON解析失败:",e),null}}(e);if(!s)return console.warn("无法解析AI返回的指令"),{success:!1,message:"指令格式错误，无法解析"};let a={action:s.action,task:s.task};return console.log("执行AI指令:",a),t(a)},[t]),processAIResponse:(0,r.useCallback)(e=>{let s=[],a=e.match(/\{[^}]*"action"[^}]*\}/g);return a&&a.forEach((e,a)=>{try{let r=JSON.parse(e);if(r.action&&["add","complete","delete","list","clear_completed","clear_all"].includes(r.action)){let e={action:r.action,task:r.task},c=t(e);s.push(c),console.log("执行第".concat(a+1,"个指令:"),e,"结果:",c)}}catch(t){console.warn("解析指令失败:",e,t),s.push({success:!1,message:"指令".concat(a+1,"解析失败")})}}),s},[t])}}({executeInstruction:t}),b=()=>{var e;null==(e=d.current)||e.scrollIntoView({behavior:"smooth"})};(0,r.useEffect)(()=>{b()},[o]);let{messages:y,input:k,handleInputChange:f,handleSubmit:j,isLoading:N}=(0,c.Y_)({api:"/api/chat",onResponse:async e=>{console.log("AI 回复原文:",await e.text())},onFinish:e=>{console.log("AI 回复完成:",e.content),x(e.content);let t=h(e.content);t&&console.log("指令执行结果:",t)},body:{enhanceWithContext:!0}}),v=e=>new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",second:"2-digit"}),D=e=>{switch(e){case"user_message":return"\uD83D\uDCAC 用户";case"ai_response":return"\uD83E\uDD16 AI";case"action_executed":return"⚡ 执行";case"context_reference":return"\uD83D\uDD17 引用";default:return"\uD83D\uDCDD"}};return(0,a.jsxs)("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg h-full flex flex-col",children:[(0,a.jsxs)("div",{className:"p-4 border-b border-gray-200 dark:border-gray-700",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h2",{className:"text-lg font-semibold text-gray-800 dark:text-white",children:"\uD83E\uDD16 AI 助手"}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("button",{onClick:()=>l(!s),className:"px-3 py-1 text-xs rounded-full transition-colors ".concat(s?"bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300":"bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400"),title:"切换记忆视图",children:s?"\uD83D\uDCAC 对话":"\uD83E\uDDE0 记忆"}),o.length>0&&(0,a.jsx)("button",{onClick:p,className:"px-3 py-1 text-xs bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors",title:"清除记忆",children:"\uD83D\uDDD1️"})]})]}),(0,a.jsxs)("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-1",children:["支持上下文对话 | 记忆条目: ",o.length]}),i.lastAddedTask&&(0,a.jsx)("div",{className:"mt-2 p-2 bg-blue-50 dark:bg-blue-900/20 rounded text-xs",children:(0,a.jsxs)("span",{className:"text-blue-600 dark:text-blue-400",children:["\uD83D\uDCA1 最后添加: “",i.lastAddedTask.text,"”"]})})]}),(0,a.jsx)("div",{className:"flex-1 p-4 overflow-y-auto",children:s?(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-3",children:"\uD83D\uDCDD 对话记忆"}),0===o.length?(0,a.jsx)("p",{className:"text-gray-500 dark:text-gray-400 text-sm text-center py-4",children:"暂无记忆记录"}):o.map(e=>(0,a.jsxs)("div",{className:"p-2 rounded-lg text-xs ".concat("user_message"===e.type?"bg-blue-50 dark:bg-blue-900/20 border-l-2 border-blue-300":"ai_response"===e.type?"bg-green-50 dark:bg-green-900/20 border-l-2 border-green-300":"action_executed"===e.type?"bg-yellow-50 dark:bg-yellow-900/20 border-l-2 border-yellow-300":"bg-purple-50 dark:bg-purple-900/20 border-l-2 border-purple-300"),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,a.jsx)("span",{className:"font-medium",children:D(e.type)}),(0,a.jsx)("span",{className:"text-gray-400",children:v(e.timestamp)})]}),(0,a.jsx)("p",{className:"text-gray-700 dark:text-gray-300",children:e.content}),e.metadata&&(0,a.jsxs)("div",{className:"mt-1 text-gray-500",children:[e.metadata.action&&(0,a.jsxs)("span",{children:["动作: ",e.metadata.action]}),e.metadata.taskId&&(0,a.jsxs)("span",{children:[" | ID: ",e.metadata.taskId]})]})]},e.id))]}):(0,a.jsxs)("div",{className:"space-y-4",children:[0===y.length?(0,a.jsxs)("div",{className:"text-center py-4",children:[(0,a.jsx)("p",{className:"text-gray-500 dark:text-gray-400 text-sm mb-2",children:"\uD83D\uDC4B 你好！我是你的AI助手"}),(0,a.jsx)("p",{className:"text-xs text-gray-400 dark:text-gray-500",children:"我可以帮你管理待办事项，支持以下功能："}),(0,a.jsxs)("div",{className:"mt-2 text-xs text-gray-400 space-y-1",children:[(0,a.jsx)("p",{children:"✅ “帮我添加一个学习任务”"}),(0,a.jsx)("p",{children:"\uD83D\uDD04 “再加一个类似的任务”"}),(0,a.jsx)("p",{children:"✅ “完成刚才那个任务”"}),(0,a.jsx)("p",{children:"\uD83D\uDDD1️ “把最后添加的删了”"}),(0,a.jsx)("p",{children:"\uD83D\uDCCB “显示所有任务”"})]})]}):y.map(e=>(0,a.jsx)("div",{className:"flex ".concat("user"===e.role?"justify-end":"justify-start"),children:(0,a.jsx)("div",{className:"max-w-[80%] p-3 rounded-lg text-sm ".concat("user"===e.role?"bg-blue-500 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white"),children:"user"===e.role?e.content.split("\n")[0].replace("用户消息: ",""):e.content})},e.id)),N&&(0,a.jsx)("div",{className:"flex justify-start",children:(0,a.jsx)("div",{className:"bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white p-3 rounded-lg text-sm",children:(0,a.jsxs)("div",{className:"flex items-center space-x-1",children:[(0,a.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce"}),(0,a.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),(0,a.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})})}),(0,a.jsx)("div",{ref:d})]})}),(0,a.jsx)("div",{className:"p-4 border-t border-gray-200 dark:border-gray-700",children:(0,a.jsxs)("form",{onSubmit:e=>{if(e.preventDefault(),!k.trim()||N)return;let t=k.trim();u(t);let s=g(t),a=m(),r=t;s&&(r="用户消息: ".concat(t,"\n\n上下文解析: ").concat(s.resolvedText,"\n"),"task_reference"===s.type&&s.taskId&&(r+="引用的任务ID: ".concat(s.taskId,"\n"))),a&&(r+="\n历史上下文:\n".concat(a)),f({target:{value:r+="\n请基于以上上下文理解用户的真实意图，并生成相应的操作指令。"}}),setTimeout(()=>{j(e),f({target:{value:""}})},0)},className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("input",{value:k,onChange:f,placeholder:"输入消息，支持上下文引用...",className:"flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white",disabled:N}),(0,a.jsx)("button",{type:"submit",disabled:N||!k.trim(),className:"px-4 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed text-white rounded-lg transition-colors text-sm font-medium",children:N?"⏳":"发送"})]}),(0,a.jsx)("div",{className:"flex flex-wrap gap-1",children:["再加一个任务","完成刚才那个","删除最后一个","显示所有任务"].map(e=>(0,a.jsx)("button",{type:"button",onClick:()=>{f({target:{value:e}})},className:"px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 rounded transition-colors",disabled:N,children:e},e))})]})})]})}class d{registerFunction(e,t){this.functionMap.set(e,t)}executeInstruction(e){let t=this.functionMap.get(e.action);if(!t)return console.warn('未找到操作 "'.concat(e.action,'" 对应的函数')),{success:!1,message:"不支持的操作: ".concat(e.action)};try{let s;switch(e.action){case"add":s=t(e.task);break;case"complete":case"delete":s=t(e.id||e.task);break;default:s=t()}if("object"==typeof s&&null!==s&&"success"in s)return s;return{success:!0,message:'操作 "'.concat(e.action,'" 执行成功'),data:s}}catch(t){return console.error("执行指令时发生错误:",t),{success:!1,message:'执行操作 "'.concat(e.action,'" 时发生错误')}}}getRegisteredActions(){return Array.from(this.functionMap.keys())}supportsAction(e){return this.functionMap.has(e)}constructor(){this.functionMap=new Map}}let o=new d;function i(e,t){return e.find(e=>e.text.toLowerCase().includes(t.toLowerCase())||t.toLowerCase().includes(e.text.toLowerCase()))}function u(){let[e,t]=(0,r.useState)([]),[s,c]=(0,r.useState)(""),{recordAction:d}=n(),{executeInstruction:u,getSupportedActions:x,addTodo:g,clearCompleted:m,clearAll:p}=function(e){let{todos:t,setTodos:s,onActionExecuted:a}=e,c=(0,r.useCallback)(e=>{let r="string"==typeof e?e:String(e||"");if(!r||""===r.trim())return{success:!1,message:"任务内容不能为空"};let c={id:Date.now(),text:r.trim(),completed:!1};return s([...t,c]),null==a||a("add",c.id,c.text),{success:!0,message:"已添加任务: ".concat(r),data:c}},[t,s,a]),n=(0,r.useCallback)(e=>{let r;return e?(r="number"==typeof e?t.find(t=>t.id===e):i(t,e))?r.completed?{success:!1,message:'任务 "'.concat(r.text,'" 已经完成了')}:(s(t.map(e=>e.id===r.id?{...e,completed:!0}:e)),null==a||a("complete",r.id,r.text),{success:!0,message:"已完成任务: ".concat(r.text),data:{...r,completed:!0}}):{success:!1,message:"未找到任务: ".concat(e)}:{success:!1,message:"请指定要完成的任务"}},[t,s,a]),l=(0,r.useCallback)(e=>{let r;return e?(r="number"==typeof e?t.find(t=>t.id===e):i(t,e))?(s(t.filter(e=>e.id!==r.id)),null==a||a("delete",r.id,r.text),{success:!0,message:"已删除任务: ".concat(r.text),data:r}):{success:!1,message:"未找到任务: ".concat(e)}:{success:!1,message:"请指定要删除的任务"}},[t,s,a]),d=(0,r.useCallback)(()=>{let e=t.filter(e=>e.completed).length,s=t.length-e;return null==a||a("list"),{success:!0,message:"共有 ".concat(t.length," 个任务，其中 ").concat(e," 个已完成，").concat(s," 个待完成"),data:t}},[t,a]),u=(0,r.useCallback)(()=>{let e=t.filter(e=>e.completed);return 0===e.length?{success:!1,message:"没有已完成的任务需要清除"}:(s(t.filter(e=>!e.completed)),null==a||a("clear_completed"),{success:!0,message:"已清除 ".concat(e.length," 个已完成的任务"),data:e})},[t,s,a]),x=(0,r.useCallback)(()=>{if(0===t.length)return{success:!1,message:"没有任务需要清除"};let e=t.length;return s([]),null==a||a("clear_all"),{success:!0,message:"已清除所有 ".concat(e," 个任务"),data:t}},[t,s,a]);return(0,r.useEffect)(()=>{o.registerFunction("add",c),o.registerFunction("complete",n),o.registerFunction("delete",l),o.registerFunction("list",d),o.registerFunction("clear_completed",u),o.registerFunction("clear_all",x)},[c,n,l,d,u,x]),{executeInstruction:(0,r.useCallback)(e=>{console.log("执行指令:",e);let t=o.executeInstruction(e);return console.log("执行结果:",t),t},[]),getSupportedActions:(0,r.useCallback)(()=>o.getRegisteredActions(),[]),addTodo:c,completeTodo:n,deleteTodo:l,listTodos:d,clearCompleted:u,clearAll:x}}({todos:e,setTodos:t,onActionExecuted:d}),h=()=>{if(""!==s.trim()){let e=g(s.trim());e.success?c(""):console.error("添加任务失败:",e.message)}},b=e=>{let t=u({action:"delete",id:e});t.success||console.error("删除任务失败:",t.message)},y=s=>{let a=e.find(e=>e.id===s);if(a&&!a.completed){let e=u({action:"complete",id:s});e.success||console.error("完成任务失败:",e.message)}else a&&a.completed&&t(e.map(e=>e.id===s?{...e,completed:!1}:e))},k=e.filter(e=>e.completed).length,f=e.length;return(0,a.jsx)("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 p-4",children:(0,a.jsxs)("div",{className:"max-w-6xl mx-auto h-[calc(100vh-2rem)] flex flex-col lg:flex-row gap-6",children:[(0,a.jsxs)("div",{className:"flex-1 bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 overflow-y-auto",children:[(0,a.jsxs)("div",{className:"mb-4",children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-center text-gray-800 dark:text-white mb-2",children:"\uD83D\uDCDD 智能上下文记忆待办事项"}),(0,a.jsxs)("p",{className:"text-center text-sm text-gray-600 dark:text-gray-400",children:["AI 指令映射 + 上下文记忆 | 支持操作: ",x().join(", ")]}),(0,a.jsx)("p",{className:"text-center text-xs text-gray-500 dark:text-gray-500 mt-1",children:"\uD83D\uDCA1 支持上下文引用：“再加一个任务”、“完成刚才那个”、“删除最后添加的”"})]}),(0,a.jsxs)("div",{className:"flex gap-2 mb-6",children:[(0,a.jsx)("input",{type:"text",value:s,onChange:e=>c(e.target.value),onKeyPress:e=>"Enter"===e.key&&h(),placeholder:"添加新任务...",className:"flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"}),(0,a.jsx)("button",{onClick:h,className:"px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors duration-200 font-medium",children:"添加"})]}),f>0&&(0,a.jsx)("div",{className:"mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg",children:(0,a.jsxs)("p",{className:"text-sm text-gray-600 dark:text-gray-300 text-center",children:["总计: ",f," 任务 | 已完成: ",k," 任务 | 剩余: ",f-k," 任务"]})}),(0,a.jsx)("div",{className:"space-y-2",children:0===e.length?(0,a.jsxs)("div",{className:"text-center py-8",children:[(0,a.jsx)("p",{className:"text-gray-500 dark:text-gray-400 text-lg",children:"暂无任务，添加一个新任务开始吧！"}),(0,a.jsxs)("p",{className:"text-sm text-gray-400 dark:text-gray-500 mt-2",children:["\uD83D\uDCA1 你可以直接在此添加，或向",(0,a.jsx)("span",{className:"lg:inline hidden",children:"右侧"}),(0,a.jsx)("span",{className:"lg:hidden inline",children:"下方"}),"的 AI 助手发送指令"]}),(0,a.jsx)("p",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:"例如：“帮我添加一个学习任务” 或 “添加买菜任务”"}),(0,a.jsx)("p",{className:"text-xs text-gray-400 dark:text-gray-500 mt-1",children:"\uD83D\uDD17 支持上下文：“再加一个类似的” 或 “完成刚才那个”"})]}):e.map(e=>(0,a.jsxs)("div",{className:"flex items-center gap-3 p-3 rounded-lg border transition-all duration-200 ".concat(e.completed?"bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800":"bg-white dark:bg-gray-700 border-gray-200 dark:border-gray-600 hover:shadow-md"),children:[(0,a.jsx)("input",{type:"checkbox",checked:e.completed,onChange:()=>y(e.id),className:"w-5 h-5 text-blue-600 rounded focus:ring-blue-500 focus:ring-2"}),(0,a.jsx)("span",{className:"flex-1 ".concat(e.completed?"line-through text-gray-500 dark:text-gray-400":"text-gray-800 dark:text-white"),children:e.text}),(0,a.jsxs)("span",{className:"text-xs text-gray-400 dark:text-gray-500",children:["ID: ",e.id]}),(0,a.jsx)("button",{onClick:()=>b(e.id),className:"px-3 py-1 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded transition-colors duration-200",title:"删除任务",children:"\uD83D\uDDD1️"})]},e.id))}),e.length>0&&(0,a.jsxs)("div",{className:"mt-6 flex gap-2 justify-center",children:[(0,a.jsxs)("button",{onClick:()=>{let e=m();e.success||console.error("清除已完成任务失败:",e.message)},className:"px-4 py-2 text-sm bg-red-100 hover:bg-red-200 text-red-700 rounded-lg transition-colors duration-200",disabled:0===k,children:["清除已完成 (",k,")"]}),(0,a.jsx)("button",{onClick:()=>{let e=p();e.success||console.error("清除所有任务失败:",e.message)},className:"px-4 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors duration-200",children:"清除全部"})]})]}),(0,a.jsx)("div",{className:"w-full lg:w-80 h-96 lg:h-full",children:(0,a.jsx)(l,{executeInstruction:u})})]})})}},7257:(e,t,s)=>{Promise.resolve().then(s.bind(s,1113))}},e=>{var t=t=>e(e.s=t);e.O(0,[490,441,684,358],()=>t(7257)),_N_E=e.O()}]);
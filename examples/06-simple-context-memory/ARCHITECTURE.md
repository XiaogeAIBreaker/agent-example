# ç®€å•ä¸Šä¸‹æ–‡è®°å¿†ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## ç³»ç»Ÿæ¦‚è§ˆ

ç®€å•ä¸Šä¸‹æ–‡è®°å¿†ç³»ç»Ÿæ˜¯ä¸€ä¸ªæ”¯æŒä¸Šä¸‹æ–‡è®°å¿†çš„å¯¹è¯å¼æ™ºèƒ½ä½“ï¼Œé€šè¿‡ä¿æŒå®Œæ•´å¯¹è¯å†å²æ¥å®ç°ç®€å•è€Œæœ‰æ•ˆçš„ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½ã€‚è¯¥ç³»ç»Ÿèƒ½å¤Ÿç†è§£"å†åŠ ä¸€ä¸ª"ã€"åˆšæ‰é‚£ä¸ª"ç­‰å¼•ç”¨ï¼Œå±•ç¤ºäº†é€šè¿‡AIæ™ºèƒ½ç†è§£è€Œéå¤æ‚è®°å¿†ç®¡ç†æ¥å®ç°ä¸Šä¸‹æ–‡åŠŸèƒ½çš„æœ‰æ•ˆæ–¹æ³•ã€‚

## æ ¸å¿ƒæ¶æ„

### 1. æ•´ä½“æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·ç•Œé¢å±‚ (UI Layer)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    ä¸Šä¸‹æ–‡ä¿¡æ¯å±•ç¤º        â”‚           å¯¹è¯äº¤äº’åŒºåŸŸ                        â”‚  â”‚
â”‚  â”‚  â€¢ è®°å¿†çŠ¶æ€æ˜¾ç¤º          â”‚  â€¢ å®Œæ•´å¯¹è¯å†å²                             â”‚  â”‚
â”‚  â”‚  â€¢ æœ€åæ“ä½œè®°å½•          â”‚  â€¢ ä¸Šä¸‹æ–‡å¼•ç”¨å¤„ç†                           â”‚  â”‚
â”‚  â”‚  â€¢ æ™ºèƒ½å»ºè®®å±•ç¤º          â”‚  â€¢ å¿«æ·æ“ä½œæŒ‰é’®                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APIç½‘å…³å±‚ (API Gateway)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    /api/chat (POST)                                     â”‚ â”‚
â”‚  â”‚  â€¢ æ¥æ”¶å®Œæ•´æ¶ˆæ¯å†å²    â€¢ ä¸Šä¸‹æ–‡åˆ†æ      â€¢ æµå¼å“åº”ç”Ÿæˆ                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸Šä¸‹æ–‡è®°å¿†å±‚ (Context Memory Layer)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   å†å²ç®¡ç†å™¨         â”‚    å¼•ç”¨è§£æå™¨        â”‚      è®°å¿†æå–å™¨          â”‚    â”‚
â”‚  â”‚                    â”‚                    â”‚                        â”‚    â”‚
â”‚  â”‚â€¢ å®Œæ•´å†å²ä¿æŒ       â”‚â€¢ ä¸Šä¸‹æ–‡å¼•ç”¨è¯†åˆ«     â”‚â€¢ å…³é”®ä¿¡æ¯æå–           â”‚    â”‚
â”‚  â”‚â€¢ æ¶ˆæ¯é“¾ç®¡ç†         â”‚â€¢ æ„å›¾åˆ†æ           â”‚â€¢ æœ€åæ“ä½œè®°å½•           â”‚    â”‚
â”‚  â”‚â€¢ è‡ªåŠ¨ä¼ é€’           â”‚â€¢ æ™ºèƒ½æ¨ç†           â”‚â€¢ çŠ¶æ€ä¿¡æ¯ç»´æŠ¤           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æŒ‡ä»¤æ‰§è¡Œå±‚ (Instruction Layer)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   æŒ‡ä»¤è§£æå™¨         â”‚      æ‰§è¡Œå¼•æ“        â”‚      ç»“æœå¤„ç†å™¨          â”‚    â”‚
â”‚  â”‚                    â”‚                    â”‚                        â”‚    â”‚
â”‚  â”‚â€¢ JSONæŒ‡ä»¤æå–       â”‚â€¢ ä»»åŠ¡æ“ä½œ           â”‚â€¢ ç»“æœåé¦ˆ               â”‚    â”‚
â”‚  â”‚â€¢ ä¸Šä¸‹æ–‡å¢å¼º         â”‚â€¢ çŠ¶æ€æ›´æ–°           â”‚â€¢ è®°å¿†æ›´æ–°               â”‚    â”‚
â”‚  â”‚â€¢ æ™ºèƒ½è¡¥å…¨           â”‚â€¢ é”™è¯¯å¤„ç†           â”‚â€¢ ç•Œé¢åŒæ­¥               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AIæœåŠ¡å±‚ (AI Service Layer)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      DeepSeek API                                       â”‚ â”‚
â”‚  â”‚  â€¢ å†å²ä¸Šä¸‹æ–‡ç†è§£    â€¢ å¼•ç”¨å…³ç³»åˆ†æ      â€¢ å¢å¼ºæŒ‡ä»¤ç”Ÿæˆ                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. è®°å¿†æ•°æ®æµæ¶æ„

```
ç”¨æˆ·è¾“å…¥ â†’ å†å²æ¶ˆæ¯åˆå¹¶ â†’ AIä¸Šä¸‹æ–‡åˆ†æ â†’ æ™ºèƒ½æŒ‡ä»¤ç”Ÿæˆ
    â†“                                           â†“
ç•Œé¢æ›´æ–° â† è®°å¿†çŠ¶æ€æ›´æ–° â† æ‰§è¡Œç»“æœå¤„ç† â† ä¸Šä¸‹æ–‡å¢å¼ºæŒ‡ä»¤
    â†“                   â†“                 â†“
æœ€åæ“ä½œè®°å½•        ä»»åŠ¡çŠ¶æ€æ›´æ–°        å¼•ç”¨å…³ç³»ç»´æŠ¤
```

### 3. ä¸Šä¸‹æ–‡å¼•ç”¨å¤„ç†æµç¨‹

```
ä¸Šä¸‹æ–‡è¾“å…¥ â†’ å¼•ç”¨è¯†åˆ« â†’ å†å²æ£€ç´¢ â†’ å…³è”åˆ†æ â†’ æ„å›¾ç†è§£ â†’ æŒ‡ä»¤ç”Ÿæˆ
      â†‘                                                 â†“
      â†â”€â”€â”€â”€â”€â”€â”€ åé¦ˆå­¦ä¹  â†â”€â”€â”€â”€ æ‰§è¡ŒéªŒè¯ â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. ContextAwareChat (ä¸Šä¸‹æ–‡æ„ŸçŸ¥èŠå¤©)

**æ ¸å¿ƒèŒè´£**:
- ç®¡ç†å®Œæ•´çš„å¯¹è¯å†å²è®°å½•
- å¤„ç†ä¸Šä¸‹æ–‡å¼•ç”¨å’Œæ„å›¾ç†è§£
- åè°ƒè®°å¿†æå–å’ŒæŒ‡ä»¤æ‰§è¡Œ
- ç»´æŠ¤åŒè§†å›¾çŠ¶æ€åŒæ­¥

**ä¸Šä¸‹æ–‡ç®¡ç†æœºåˆ¶**:
```typescript
interface ContextManager {
  // å†å²ç®¡ç†
  messages: Message[]
  
  // è®°å¿†æå–
  getLastAddedTask(): string | null
  getRecentOperations(): Operation[]
  getConversationStats(): ConversationStats
  
  // ä¸Šä¸‹æ–‡åˆ†æ
  analyzeReference(input: string): ReferenceAnalysis
  buildContextPrompt(input: string): string
}
```

**åŒè§†å›¾çŠ¶æ€ç®¡ç†**:
```typescript
const [activeView, setActiveView] = useState<'chat' | 'context'>('chat');
const [contextInfo, setContextInfo] = useState({
  lastTask: null,
  messageCount: 0,
  recentOperations: []
});
```

### 2. ContextMemoryExtractor (ä¸Šä¸‹æ–‡è®°å¿†æå–å™¨)

**æ ¸å¿ƒåŠŸèƒ½**:
- **å†å²åˆ†æ**: ä»æ¶ˆæ¯å†å²ä¸­æå–å…³é”®ä¿¡æ¯
- **æ“ä½œè·Ÿè¸ª**: è®°å½•ç”¨æˆ·çš„æ“ä½œåºåˆ—
- **çŠ¶æ€ç»´æŠ¤**: ç»´æŠ¤å½“å‰çš„è®°å¿†çŠ¶æ€
- **æ™ºèƒ½æ¨æ–­**: åŸºäºå†å²æ¨æ–­ç”¨æˆ·æ„å›¾

**è®°å¿†æå–ç®—æ³•**:
```typescript
export const getLastAddedTask = (messages: Message[]): string | null => {
  // ä»æœ€æ–°æ¶ˆæ¯å‘å‰æœç´¢
  for (let i = messages.length - 1; i >= 0; i--) {
    const msg = messages[i];
    if (msg.role === 'assistant' && msg.content.includes('"action": "add"')) {
      // æå–ä»»åŠ¡å†…å®¹
      const match = msg.content.match(/"task":\s*"([^"]+)"/);
      if (match) return match[1];
    }
  }
  return null;
};

export const getRecentOperations = (messages: Message[]): Operation[] => {
  const operations: Operation[] = [];
  
  for (let i = messages.length - 1; i >= 0 && operations.length < 5; i--) {
    const msg = messages[i];
    if (msg.role === 'assistant') {
      const instruction = parseInstruction(msg.content);
      if (instruction) {
        operations.push({
          action: instruction.action,
          task: instruction.task,
          timestamp: new Date().toISOString()
        });
      }
    }
  }
  
  return operations.reverse();
};
```

### 3. ReferenceAnalyzer (å¼•ç”¨åˆ†æå™¨)

**å¼•ç”¨ç±»å‹è¯†åˆ«**:
```typescript
interface ReferencePattern {
  pattern: RegExp;
  type: 'last_task' | 'recent_operation' | 'similar_task' | 'previous_context';
  handler: (messages: Message[], match: string[]) => ContextHint;
}

const referencePatterns: ReferencePattern[] = [
  {
    pattern: /å†(åŠ |æ·»åŠ )ä¸€?ä¸ª/,
    type: 'similar_task',
    handler: (messages, match) => ({
      type: 'similar_task',
      suggestion: `åŸºäºæœ€åæ·»åŠ çš„ä»»åŠ¡: ${getLastAddedTask(messages)}`
    })
  },
  {
    pattern: /(åˆšæ‰|æœ€è¿‘|æœ€å)(çš„|é‚£ä¸ª)?/,
    type: 'last_task',
    handler: (messages, match) => ({
      type: 'last_task',
      task: getLastAddedTask(messages)
    })
  },
  {
    pattern: /(æ¸…ç©º|æ¸…é™¤)(æ‰€æœ‰|å…¨éƒ¨)?/,
    type: 'recent_operation',
    handler: (messages, match) => ({
      type: 'clear_operation',
      context: 'å‡†å¤‡æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡'
    })
  }
];
```

**æ™ºèƒ½å¼•ç”¨è§£æ**:
```typescript
export const analyzeReference = (input: string, messages: Message[]): ReferenceAnalysis => {
  for (const pattern of referencePatterns) {
    const match = input.match(pattern.pattern);
    if (match) {
      return {
        hasReference: true,
        type: pattern.type,
        confidence: 0.9,
        context: pattern.handler(messages, match)
      };
    }
  }
  
  return { hasReference: false, confidence: 0 };
};
```

### 4. EnhancedInstructionParser (å¢å¼ºæŒ‡ä»¤è§£æå™¨)

**ä¸Šä¸‹æ–‡å¢å¼ºè§£æ**:
```typescript
export const parseInstructionWithContext = (
  message: string, 
  context: ContextInfo
): EnhancedInstruction | null => {
  const baseInstruction = parseInstruction(message);
  if (!baseInstruction) return null;
  
  // åŸºäºä¸Šä¸‹æ–‡å¢å¼ºæŒ‡ä»¤
  return {
    ...baseInstruction,
    context: {
      previousTask: context.lastTask,
      operationCount: context.messageCount,
      recentOperations: context.recentOperations
    },
    confidence: calculateConfidence(baseInstruction, context)
  };
};

const calculateConfidence = (
  instruction: Instruction, 
  context: ContextInfo
): number => {
  let confidence = 0.8; // åŸºç¡€ç½®ä¿¡åº¦
  
  // å¦‚æœæœ‰æ˜ç¡®çš„ä»»åŠ¡å†…å®¹ï¼Œæé«˜ç½®ä¿¡åº¦
  if (instruction.task && instruction.task.length > 2) {
    confidence += 0.1;
  }
  
  // å¦‚æœä¸å†å²æ“ä½œä¸€è‡´ï¼Œæé«˜ç½®ä¿¡åº¦
  if (context.recentOperations.some(op => op.action === instruction.action)) {
    confidence += 0.1;
  }
  
  return Math.min(confidence, 1.0);
};
```

### 5. ContextAwarePromptBuilder (ä¸Šä¸‹æ–‡æ„ŸçŸ¥æç¤ºè¯æ„å»ºå™¨)

**å¢å¼ºç³»ç»Ÿæç¤ºè¯**:
```typescript
const buildContextAwarePrompt = (messages: Message[]): string => {
  const lastTask = getLastAddedTask(messages);
  const recentOps = getRecentOperations(messages);
  
  return `ä½ æ˜¯ä¸€ä¸ªå…·æœ‰ä¸Šä¸‹æ–‡è®°å¿†èƒ½åŠ›çš„æ™ºèƒ½å¾…åŠäº‹é¡¹åŠ©æ‰‹ã€‚

## å½“å‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š
- æœ€åæ·»åŠ çš„ä»»åŠ¡: ${lastTask || 'æ— '}
- æœ€è¿‘æ“ä½œå†å²: ${recentOps.map(op => `${op.action}(${op.task || ''})`).join(', ')}
- å¯¹è¯è½®æ•°: ${messages.length}

## ä¸Šä¸‹æ–‡å¼•ç”¨è§„åˆ™ï¼š
1. "å†åŠ ä¸€ä¸ª/å†æ·»åŠ " â†’ åŸºäºæœ€åæ·»åŠ çš„ä»»åŠ¡ç±»å‹
2. "åˆšæ‰/æœ€è¿‘/æœ€åçš„" â†’ å¼•ç”¨æœ€è¿‘çš„ä»»åŠ¡æˆ–æ“ä½œ
3. "æ¸…ç©º/æ¸…é™¤" â†’ æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡
4. "é‚£ä¸ª/è¿™ä¸ª" â†’ æ ¹æ®ä¸Šä¸‹æ–‡åˆ¤æ–­å…·ä½“å¼•ç”¨

è¯·ä»”ç»†åˆ†æç”¨æˆ·è¾“å…¥ä¸­çš„ä¸Šä¸‹æ–‡å¼•ç”¨ï¼Œæ­£ç¡®ç†è§£ç”¨æˆ·æ„å›¾ã€‚`;
};
```

## æŠ€æœ¯æ ˆè¯¦è§£

### 1. å‰ç«¯æŠ€æœ¯æ ˆ

```
Next.js 14 + React 18 + TypeScript
â”œâ”€â”€ UIæ¡†æ¶: Tailwind CSS + å“åº”å¼è®¾è®¡
â”œâ”€â”€ çŠ¶æ€ç®¡ç†: React Hooks + Context API
â”œâ”€â”€ AIé›†æˆ: Vercel AI SDK (@ai-sdk/react)
â”œâ”€â”€ è®°å¿†ç®¡ç†: å®¢æˆ·ç«¯å†…å­˜ + æ™ºèƒ½ç®—æ³•
â””â”€â”€ äº¤äº’è®¾è®¡: åŒè§†å›¾åˆ‡æ¢ + å®æ—¶æ›´æ–°
```

### 2. è®°å¿†æŠ€æœ¯æ ˆ

```
Messageså†å² + æ™ºèƒ½æå–ç®—æ³•
â”œâ”€â”€ å­˜å‚¨æ–¹å¼: useChatè‡ªåŠ¨å†å²ç®¡ç†
â”œâ”€â”€ æ£€ç´¢ç®—æ³•: æ­£åˆ™è¡¨è¾¾å¼ + è¯­ä¹‰åˆ†æ
â”œâ”€â”€ ä¸Šä¸‹æ–‡åˆ†æ: æ¨¡å¼åŒ¹é… + AIç†è§£
â”œâ”€â”€ å¼•ç”¨è§£æ: è§„åˆ™å¼•æ“ + æ™ºèƒ½æ¨ç†
â””â”€â”€ çŠ¶æ€åŒæ­¥: ReactçŠ¶æ€ + å®æ—¶æ›´æ–°
```

### 3. AIå¢å¼ºæŠ€æœ¯æ ˆ

```
DeepSeek API + ä¸Šä¸‹æ–‡å¢å¼º
â”œâ”€â”€ æ¨¡å‹: deepseek-chat (ä¸Šä¸‹æ–‡ç†è§£èƒ½åŠ›)
â”œâ”€â”€ æç¤ºè¯: åŠ¨æ€ä¸Šä¸‹æ–‡æ³¨å…¥
â”œâ”€â”€ å“åº”: æµå¼ç”Ÿæˆ + ä¸Šä¸‹æ–‡æ„ŸçŸ¥
â””â”€â”€ é›†æˆ: å†å²ä¼ é€’ + æ™ºèƒ½ç†è§£
```

## è®¾è®¡æ¨¡å¼åº”ç”¨

### 1. å¤‡å¿˜å½•æ¨¡å¼ (Memento Pattern)

**å†å²çŠ¶æ€ç®¡ç†**:
```typescript
interface ConversationMemento {
  messages: Message[];
  lastTask: string | null;
  operationHistory: Operation[];
  timestamp: Date;
}

class ConversationHistory {
  private mementos: ConversationMemento[] = [];
  
  saveState(messages: Message[]): void {
    this.mementos.push({
      messages: [...messages],
      lastTask: getLastAddedTask(messages),
      operationHistory: getRecentOperations(messages),
      timestamp: new Date()
    });
  }
  
  restoreState(index: number): ConversationMemento | null {
    return this.mementos[index] || null;
  }
}
```

### 2. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

**å¼•ç”¨è§£æç­–ç•¥**:
```typescript
interface ReferenceStrategy {
  canHandle(input: string): boolean;
  resolve(input: string, messages: Message[]): ContextHint;
}

class SimilarTaskStrategy implements ReferenceStrategy {
  canHandle(input: string): boolean {
    return /å†(åŠ |æ·»åŠ )ä¸€?ä¸ª/.test(input);
  }
  
  resolve(input: string, messages: Message[]): ContextHint {
    const lastTask = getLastAddedTask(messages);
    return {
      type: 'similar_task',
      suggestion: `åŸºäºä»»åŠ¡: ${lastTask}`,
      confidence: lastTask ? 0.9 : 0.3
    };
  }
}
```

### 3. è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

**è®°å¿†çŠ¶æ€é€šçŸ¥**:
```typescript
interface MemoryObserver {
  onMemoryUpdate(context: ContextInfo): void;
}

class MemoryManager {
  private observers: MemoryObserver[] = [];
  
  addObserver(observer: MemoryObserver): void {
    this.observers.push(observer);
  }
  
  notifyMemoryUpdate(context: ContextInfo): void {
    this.observers.forEach(observer => observer.onMemoryUpdate(context));
  }
}
```

## ç”¨æˆ·ä½“éªŒè®¾è®¡

### 1. åŒè§†å›¾ç•Œé¢è®¾è®¡

**å¯¹è¯è§†å›¾**:
```typescript
const ChatView = ({ messages, onSendMessage }) => (
  <div className="flex-1 flex flex-col">
    <div className="flex-1 overflow-y-auto p-4">
      {messages.map((msg, index) => (
        <MessageBubble key={index} message={msg} />
      ))}
    </div>
    <ChatInput onSend={onSendMessage} />
  </div>
);
```

**ä¸Šä¸‹æ–‡è§†å›¾**:
```typescript
const ContextView = ({ contextInfo }) => (
  <div className="flex-1 p-4 bg-gray-50">
    <ContextSummary info={contextInfo} />
    <RecentOperations operations={contextInfo.recentOperations} />
    <SmartSuggestions suggestions={generateSuggestions(contextInfo)} />
  </div>
);
```

### 2. ä¸Šä¸‹æ–‡æç¤ºè®¾è®¡

**æ™ºèƒ½å ä½ç¬¦**:
```typescript
const getContextualPlaceholder = (contextInfo: ContextInfo): string => {
  if (contextInfo.lastTask) {
    return `è¯•è¯•è¯´"å†åŠ ä¸€ä¸ªç±»ä¼¼çš„ä»»åŠ¡"æˆ–"åˆšæ‰é‚£ä¸ªä»»åŠ¡å®Œæˆäº†"`;
  }
  if (contextInfo.messageCount === 0) {
    return "å‘Šè¯‰æˆ‘ä½ æƒ³è¦æ·»åŠ ä»€ä¹ˆä»»åŠ¡...";
  }
  return "ç»§ç»­å¯¹è¯ï¼Œæˆ‘è®°å¾—æˆ‘ä»¬ä¹‹å‰èŠäº†ä»€ä¹ˆ...";
};
```

**è®°å¿†çŠ¶æ€æŒ‡ç¤ºå™¨**:
```typescript
const MemoryIndicator = ({ contextInfo }) => (
  <div className="text-sm text-gray-500 mb-2">
    ğŸ’­ è®°ä½äº†: {contextInfo.lastTask || 'æš‚æ— ä»»åŠ¡'} 
    ğŸ“Š å¯¹è¯è½®æ•°: {contextInfo.messageCount}
    {contextInfo.lastTask && (
      <span className="ml-2 text-blue-500">
        è¯•è¯•è¯´"å†åŠ ä¸€ä¸ª"
      </span>
    )}
  </div>
);
```

### 3. ä¸Šä¸‹æ–‡åé¦ˆè®¾è®¡

**å¼•ç”¨è¯†åˆ«åé¦ˆ**:
```typescript
const ReferenceIndicator = ({ analysis }) => {
  if (!analysis.hasReference) return null;
  
  return (
    <div className="bg-blue-50 border-l-4 border-blue-400 p-3 mb-4">
      <div className="flex">
        <div className="flex-shrink-0">
          ğŸ”—
        </div>
        <div className="ml-3">
          <p className="text-sm text-blue-700">
            æ£€æµ‹åˆ°ä¸Šä¸‹æ–‡å¼•ç”¨: {analysis.type}
          </p>
          <p className="text-xs text-blue-600 mt-1">
            ç½®ä¿¡åº¦: {(analysis.confidence * 100).toFixed(0)}%
          </p>
        </div>
      </div>
    </div>
  );
};
```

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. è®°å¿†æ£€ç´¢ä¼˜åŒ–

**å†å²ç¼“å­˜**:
```typescript
class MemoryCache {
  private cache = new Map<string, any>();
  private maxSize = 100;
  
  get(key: string): any {
    return this.cache.get(key);
  }
  
  set(key: string, value: any): void {
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    this.cache.set(key, value);
  }
}

const memoryCache = new MemoryCache();

// ç¼“å­˜æœ€åä»»åŠ¡æŸ¥è¯¢
export const getLastAddedTaskCached = (messages: Message[]): string | null => {
  const cacheKey = `last_task_${messages.length}`;
  let result = memoryCache.get(cacheKey);
  
  if (!result) {
    result = getLastAddedTask(messages);
    memoryCache.set(cacheKey, result);
  }
  
  return result;
};
```

### 2. æ™ºèƒ½å†å²è£å‰ª

**Tokenä¼˜åŒ–**:
```typescript
const optimizeMessageHistory = (messages: Message[]): Message[] => {
  const maxMessages = 20; // æœ€å¤§ä¿ç•™æ¶ˆæ¯æ•°
  const criticalMessages = 5; // å¿…é¡»ä¿ç•™çš„æœ€è¿‘æ¶ˆæ¯æ•°
  
  if (messages.length <= maxMessages) {
    return messages;
  }
  
  // ä¿ç•™æœ€è¿‘çš„å…³é”®æ¶ˆæ¯ + é‡è¦çš„å†å²èŠ‚ç‚¹
  const recentMessages = messages.slice(-criticalMessages);
  const historicalMessages = messages
    .slice(0, -criticalMessages)
    .filter(msg => msg.content.includes('"action":')) // ä¿ç•™åŒ…å«æŒ‡ä»¤çš„æ¶ˆæ¯
    .slice(-5); // æœ€å¤šä¿ç•™5ä¸ªå†å²æŒ‡ä»¤
  
  return [...historicalMessages, ...recentMessages];
};
```

### 3. ä¸Šä¸‹æ–‡è®¡ç®—ä¼˜åŒ–

**æƒ°æ€§è®¡ç®—**:
```typescript
const useContextInfo = (messages: Message[]) => {
  const contextInfo = useMemo(() => ({
    lastTask: getLastAddedTask(messages),
    messageCount: messages.length,
    recentOperations: getRecentOperations(messages)
  }), [messages.length]); // åªåœ¨æ¶ˆæ¯æ•°é‡å˜åŒ–æ—¶é‡è®¡ç®—
  
  return contextInfo;
};
```

## å®‰å…¨æ€§è®¾è®¡

### 1. è®°å¿†éšç§ä¿æŠ¤

**æ•æ„Ÿä¿¡æ¯è¿‡æ»¤**:
```typescript
const sanitizeMessageForMemory = (message: Message): Message => ({
  ...message,
  content: message.content.replace(/\b\d{4,}\b/g, '****') // è¿‡æ»¤æ•°å­—ä¿¡æ¯
});

const filterSensitiveHistory = (messages: Message[]): Message[] => {
  return messages.map(sanitizeMessageForMemory);
};
```

### 2. ä¸Šä¸‹æ–‡æ³¨å…¥é˜²æŠ¤

**æç¤ºè¯æ³¨å…¥é˜²æŠ¤**:
```typescript
const validateContextInput = (input: string): boolean => {
  const dangerousPatterns = [
    /ignore.+previous/i,
    /forget.+context/i,
    /system.+prompt/i
  ];
  
  return !dangerousPatterns.some(pattern => pattern.test(input));
};
```

## æ‰©å±•æ€§è®¾è®¡

### 1. è®°å¿†å­˜å‚¨æ‰©å±•

**æŒä¹…åŒ–è®°å¿†**:
```typescript
interface MemoryStorage {
  save(sessionId: string, context: ContextInfo): Promise<void>;
  load(sessionId: string): Promise<ContextInfo | null>;
  clear(sessionId: string): Promise<void>;
}

class LocalMemoryStorage implements MemoryStorage {
  async save(sessionId: string, context: ContextInfo): Promise<void> {
    localStorage.setItem(`memory_${sessionId}`, JSON.stringify(context));
  }
  
  async load(sessionId: string): Promise<ContextInfo | null> {
    const data = localStorage.getItem(`memory_${sessionId}`);
    return data ? JSON.parse(data) : null;
  }
}
```

### 2. ä¸Šä¸‹æ–‡ç±»å‹æ‰©å±•

**å¤šç±»å‹ä¸Šä¸‹æ–‡**:
```typescript
interface ExtendedContext extends ContextInfo {
  userPreferences: UserPreference[];
  taskCategories: TaskCategory[];
  behaviorPatterns: BehaviorPattern[];
  emotionalState: EmotionalState;
}
```

### 3. AIæ¨¡å‹æ‰©å±•

**å¤šæ¨¡å‹è®°å¿†**:
```typescript
interface MemoryModel {
  analyzeContext(messages: Message[]): Promise<ContextAnalysis>;
  generateResponse(input: string, context: ContextInfo): Promise<string>;
}

class MultiModelMemory {
  constructor(
    private primaryModel: MemoryModel,
    private fallbackModel: MemoryModel
  ) {}
  
  async processWithMemory(input: string, messages: Message[]): Promise<string> {
    try {
      const context = await this.primaryModel.analyzeContext(messages);
      return await this.primaryModel.generateResponse(input, context);
    } catch (error) {
      const context = await this.fallbackModel.analyzeContext(messages);
      return await this.fallbackModel.generateResponse(input, context);
    }
  }
}
```

## æµ‹è¯•ç­–ç•¥

### 1. è®°å¿†åŠŸèƒ½æµ‹è¯•

**ä¸Šä¸‹æ–‡è¯†åˆ«æµ‹è¯•**:
```typescript
describe('Context Recognition', () => {
  test('should identify "å†åŠ ä¸€ä¸ª" reference', () => {
    const messages = [
      { role: 'assistant', content: '```json\n{"action":"add","task":"å­¦ä¹ JavaScript"}\n```' }
    ];
    const analysis = analyzeReference('å†åŠ ä¸€ä¸ªç±»ä¼¼çš„', messages);
    expect(analysis.hasReference).toBe(true);
    expect(analysis.type).toBe('similar_task');
  });
  
  test('should extract last added task', () => {
    const messages = [
      { role: 'assistant', content: '```json\n{"action":"add","task":"å­¦ä¹ React"}\n```' }
    ];
    const lastTask = getLastAddedTask(messages);
    expect(lastTask).toBe('å­¦ä¹ React');
  });
});
```

### 2. è®°å¿†æ€§èƒ½æµ‹è¯•

**å¤§é‡å†å²å¤„ç†æµ‹è¯•**:
```typescript
test('should handle large message history efficiently', () => {
  const largeHistory = Array(1000).fill(null).map((_, i) => ({
    role: 'user',
    content: `Message ${i}`
  }));
  
  const start = performance.now();
  const context = extractContextInfo(largeHistory);
  const end = performance.now();
  
  expect(end - start).toBeLessThan(100); // åº”åœ¨100mså†…å®Œæˆ
});
```

## å­¦ä¹ ä»·å€¼æ€»ç»“

### 1. è®°å¿†ç³»ç»Ÿè®¾è®¡ç†å¿µ

**ç®€å•è€Œæœ‰æ•ˆçš„è®°å¿†æ–¹æ³•**:
- é€šè¿‡å®Œæ•´å†å²è€Œéå¤æ‚æ•°æ®åº“å®ç°è®°å¿†
- åˆ©ç”¨AIçš„ä¸Šä¸‹æ–‡ç†è§£èƒ½åŠ›è€Œéç¡¬ç¼–ç è§„åˆ™
- å¹³è¡¡åŠŸèƒ½å¤æ‚åº¦ä¸å®ç°ç®€æ´æ€§

### 2. ä¸Šä¸‹æ–‡å¤„ç†æŠ€æœ¯

**æ ¸å¿ƒæŠ€æœ¯å­¦ä¹ ç‚¹**:
- æ¶ˆæ¯å†å²çš„æ™ºèƒ½åˆ†ææ–¹æ³•
- ä¸Šä¸‹æ–‡å¼•ç”¨çš„æ¨¡å¼è¯†åˆ«
- AIå¢å¼ºçš„æ„å›¾ç†è§£æŠ€æœ¯
- å®æ—¶çŠ¶æ€åŒæ­¥æœºåˆ¶

### 3. æ¶æ„è®¾è®¡åŸåˆ™

**å¯æ‰©å±•çš„ç®€å•æ¶æ„**:
- æ¨¡å—åŒ–çš„è®°å¿†ç»„ä»¶è®¾è®¡
- çµæ´»çš„å¼•ç”¨è§£ææ¡†æ¶
- å¯æ’æ‹”çš„å­˜å‚¨é€‚é…å™¨
- æ¸è¿›å¼åŠŸèƒ½å¢å¼º

### 4. å®è·µåº”ç”¨ä»·å€¼

è¿™ä¸ªæ¡ˆä¾‹å±•ç¤ºäº†å¦‚ä½•åœ¨ä¸å¼•å…¥å¤æ‚è®°å¿†ç®¡ç†ç³»ç»Ÿçš„å‰æä¸‹ï¼Œå®ç°æœ‰æ•ˆçš„ä¸Šä¸‹æ–‡è®°å¿†åŠŸèƒ½ï¼š
- ä¸ºæ›´å¤æ‚çš„AIè®°å¿†ç³»ç»Ÿå¥ å®šåŸºç¡€
- å±•ç¤ºäº†AIèƒ½åŠ›ä¸å·¥ç¨‹å®ç°çš„å¹³è¡¡
- æä¾›äº†å¯ç›´æ¥åº”ç”¨çš„è®°å¿†è®¾è®¡æ¨¡å¼

ä¸ºåç»­çš„å¢å¼ºæç¤ºè¯ã€å‡½æ•°è°ƒç”¨ç­‰é«˜çº§åŠŸèƒ½æä¾›äº†è®°å¿†èƒ½åŠ›çš„åŸºç¡€æ”¯æ’‘ã€‚ 